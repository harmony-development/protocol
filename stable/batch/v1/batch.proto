syntax = "proto3";

package protocol.batch.v1;

// AnyRequest is a generic message supporting any unary request.
message AnyRequest {
  // The endpoint to which the request is being sent.
  string endpoint = 1;
  // The request data.
  bytes request = 2;
}

// Used in `Batch` endpoint.
message BatchRequest {
  // The list of requests to be executed in the batch.
  repeated AnyRequest requests = 1;
}

// Used in `Batch` endpoint.
message BatchResponse {
  // The list of responses to the requests.
  repeated bytes responses = 1;
}

// Used in `BatchSame` endpoint.
message BatchSameRequest {
  // The endpoint to call for all requests.
  string endpoint = 1;
  // The list of requests to be executed in the batch.
  repeated bytes requests = 2;
}
// Used in `BatchSame` endpoint.
message BatchSameResponse {
  // The list of responses to the requests.
  repeated bytes responses = 1;
}

// Service to batch requests.
//
// Note that:
//
// - This does not support batching stream requests.
// - Responses will be returned in the order the requests were given.
// - If an error occurs, the endpoint will short-circuit and return
// an error.
//
// Not all endpoints can be batched. A list of endpoints that can be
// batched is given below:
//
// - Endpoints that do not modify data:
//   - "protocol.profile.v1.ProfileService.GetProfile"
//   - "protocol.chat.v1.ChatService.QueryHasPermission"
//   - "protocol.chat.v1.ChatService.GetUserRoles"
//   - "protocol.chat.v1.ChatService.GetGuildRoles"
//   - "protocol.chat.v1.ChatService.GetGuild"
//   - "protocol.chat.v1.ChatService.GetGuildChannels"
//   - "protocol.chat.v1.ChatService.GetPermissions"
//   - "protocol.chat.v1.ChatService.GetGuildMembers"
//   - "protocol.mediaproxy.v1.MediaProxyService.FetchLinkMetadata"
//   - "protocol.mediaproxy.v1.MediaProxyService.InstantView"
//   - "protocol.mediaproxy.v1.MediaProxyService.CanInstantView"
service BatchService {
  // Batch requests.
  //
  // Servers should limit the amount of requests that can be batched
  // to 20.
  rpc Batch(BatchRequest) returns (BatchResponse) {}
  // Allows batching for requests using the same endpoint.
  //
  // This allows for additional network optimizations since the endpoint doesn't
  // have to be sent for every request.
  //
  // Servers should limit the amount of requests that can be batched
  // to 100 for endpoints that do not modify data, and 20 for endpoints
  // that modify data.
  rpc BatchSame(BatchSameRequest) returns (BatchSameResponse) {}
}
